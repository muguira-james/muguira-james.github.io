{"title":"Using_a_monorepo_with_github","date":"2022-03-29T17:34:29.000Z","date_formatted":{"ll":"Mar 29, 2022","L":"03/29/2022","MM-DD":"03-29"},"link":"2022/03/29/Using-a-monorepo-with-github","updated":"2022-03-29T19:43:22.722Z","content":"<p>Create some examples of github actions around monorepos</p>\n<span id=\"more\"></span>\n<h1 id=\"introduction\">Introduction<a title=\"#introduction\" href=\"#introduction\"></a></h1>\n<p>Recently, a co-worker was struggling with github actions.  They had a monorepo, or a single repository with a front end and back end code in it.  Many organizations would require that you create two repos: one for the front end and one for the backend.</p>\n<p>There are a lot of reasons to use monorepos and many for not using them. I’m not going there. This post will show you how to get the builds going and point out a number of pit falls along the way.</p>\n<h1 id=\"background\">Background<a title=\"#background\" href=\"#background\"></a></h1>\n<p>There are MANY explainations of github monorepos on the web. However, they have the same problems: the author shows you a specific solution, which many times is very complex and the author fails to show you how they got to that specific solution. Also, there are a number of places where you have to write the action yaml file in a specific way or it does not achieve what you want.</p>\n<p>Github is a very powerful code version system. It is available to everybody and so far Microsoft has maintained a free tier. A few years ago, github added “actions”, which effectively make it the center piece of a complete continuous integration and continuous deployment (CI/CD) system. Actions can:</p>\n<ul>\n<li>build your code</li>\n<li>run tests on your code</li>\n<li>package your code for testing, or putting the code into containers / VMs.</li>\n<li>handle deploying your system, for example: to a container registry or production</li>\n</ul>\n<p>Actions are independent of the programming language used to write the code. The github community has supplied lots of example actions to solve a multitude of problems. There is even a market place full of ready to use actions to solve simple or complex automation tasks. With Actions, github can completely replace, legacy systems like Jenkins, Travis or CircleCI.</p>\n<h1 id=\"our-environment\">Our environment<a title=\"#our-environment\" href=\"#our-environment\"></a></h1>\n<p>We are going to write 2 simple programs: a backend program (in the bend directory) in node that exposes an API; and a front end (in the fend directory) in ReactJS to consume that API and do some display. Both of these programs are bare bones, they utilize as little as possible of node and React. Their purpose is to provide code we can build and test against.</p>\n<p>First, let’s examine the directory structure:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls -R</span><br><span class=\"line\">LICENSEs''s''README.md\tbend\t\tfend</span><br><span class=\"line\"></span><br><span class=\"line\">./bend:</span><br><span class=\"line\">db.jsons''s''s''package.json\t\ttest</span><br><span class=\"line\">package-lock.jsons''srvr.js</span><br><span class=\"line\"></span><br><span class=\"line\">./bend/test:</span><br><span class=\"line\">test.mjs</span><br><span class=\"line\"></span><br><span class=\"line\">./fend:</span><br><span class=\"line\">README.mds''s''package.json\t\tsrc</span><br><span class=\"line\">package-lock.jsons''public</span><br><span class=\"line\"></span><br><span class=\"line\">./fend/public:</span><br><span class=\"line\">favicon.icos''logo192.png\tmanifest.json</span><br><span class=\"line\">index.htmls''logo512.png\trobots.txt</span><br><span class=\"line\"></span><br><span class=\"line\">./fend/src:</span><br><span class=\"line\">App.csss''s''App.test.js\tindex.css\tsetupTests.js</span><br><span class=\"line\">App.jss''s''getList.js\tindex.js</span><br><span class=\"line\">$</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>At the top level there are 4 files: a license file, a <a href=\"http://README.md\">README.md</a> file and the bend and fend directories. The bend directory has source, package files for node and a test directory. The fend directory has a public and src directories.</p>\n<h1 id=\"github-setup\">Github setup<a title=\"#github-setup\" href=\"#github-setup\"></a></h1>\n<p>Let’s take a look at the github side. Github actions are designed to execute when “events” take place on the repository. In this case, we’ll use a “push” event to trigger our “build &amp; test” activity. Github actions use a yaml file structure to define what the action will do. We are going to take advantage of the “on:” and the “jobs” keywords. The “on:” keyword can be used to define triggers like push, pull_request and others.</p>\n<p>Actions are defined by creating a “.github/workflow” subdirectory in the root of your repo.  This subdirectory will define actions for various triggers, events and other github actvity.</p>\n<h3 id=\"pit-fall-#1---build-and-test-just-the-subsystem-that-changed!\">Pit fall #1 - build and test JUST THE SUBSYSTEM that changed!<a title=\"#pit-fall-#1---build-and-test-just-the-subsystem-that-changed!\" href=\"#pit-fall-#1---build-and-test-just-the-subsystem-that-changed!\"></a></h3>\n<p>Github actions normally expect a repository to contain a single, self contained sub-system. Default actions expect all of the code for building / testing or what have you to exist in the root of our repo. Our build and test codes (i.e. the package.json and package-lock files) to live in the subdirectories. Our .github/workflow codebase and directory structure look like this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -a .github/workflows/</span><br><span class=\"line\">bend.yaml fend.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>In other words, we have a bend.yaml and a fend.yaml file to define what happens in those specific subdirectories.</p>\n<p>In our case, we have 2: our frontend and backend. On a push to a specific directory we need a way to have the actions code watch and drive the correct build and test code. The “on:” keyword provides a “paths:” statement. When we use the “paths:” statement we are telling github to watch for changes along those paths. Here is an example for the backend:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">on: </span><br><span class=\"line\">  push:</span><br><span class=\"line\">    branches: </span><br><span class=\"line\">      - main</span><br><span class=\"line\">    paths:</span><br><span class=\"line\">      - &quot;bend/**&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">jobs:</span><br><span class=\"line\">  build:</span><br><span class=\"line\">    runs-on: ubuntu-latest</span><br><span class=\"line\">    steps:</span><br><span class=\"line\">      - uses: actions/checkout@v2</span><br><span class=\"line\">      - uses: actions/setup-node@v2</span><br><span class=\"line\">      - name: Install Dependencies</span><br><span class=\"line\">        run: |</span><br><span class=\"line\">          cd bend</span><br><span class=\"line\">          npm ci</span><br><span class=\"line\">          npm test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Here is the frontend:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">on: </span><br><span class=\"line\">  push:</span><br><span class=\"line\">    branches: </span><br><span class=\"line\">      - main</span><br><span class=\"line\">    paths:</span><br><span class=\"line\">      - &quot;fend/**&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">jobs:</span><br><span class=\"line\">  build:</span><br><span class=\"line\">    runs-on: ubuntu-latest</span><br><span class=\"line\">    steps:</span><br><span class=\"line\">      - uses: actions/checkout@v2</span><br><span class=\"line\">      - uses: actions/setup-node@v2</span><br><span class=\"line\">      - name: Install Dependencies</span><br><span class=\"line\">        run: |</span><br><span class=\"line\">          cd fend</span><br><span class=\"line\">          npm ci</span><br><span class=\"line\">          npm test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>The snipit says: “on branch main, watch for changes in the bend sub directory”. So we define a yaml file for each subdirectory we want to operate on.</p>\n<p>The “jobs:” statement for both fend and bend is very similar: setup ubuntu (should use a specific version here, “not LATEST”), do a checkout, do a setup of node, run “npm ci”, run test and finish.</p>\n<p>The “npm ci” is similar to using “npm install”. It sets a couple of environment variables which tell the test runners (mocha and Jest) they are operating in a Ci/CD environment, not the command line. The big difference is that both mocha and Jest know to stop at the end of the test instead of waiting for interactive input.</p>\n<p>We can test at this point to see if github ONLY reacts to changes in the subdirectory.</p>\n<ul>\n<li>1: change the top level <a href=\"http://readme.md\">readme.md</a> file. On the github site, the github actions tab should NOT show any activity.</li>\n<li>2: change the <a href=\"http://readme.md\">readme.md</a> inside of the bend. The github actions tab to kick off a build of JUST the bend.</li>\n<li>3: change the <a href=\"http://readme.md\">readme.md</a> inside the fend. The github actions tab to kick off a build of JUST the fend.</li>\n</ul>\n<h3 id=\"pit-fall-#2---why-do-we-have-that-package-lock.json-file?\">Pit fall #2 - why do we have that package-lock.json file?<a title=\"#pit-fall-#2---why-do-we-have-that-package-lock.json-file?\" href=\"#pit-fall-#2---why-do-we-have-that-package-lock.json-file?\"></a></h3>\n<p>Let’s delete the package-lock.json file and see what we get. You can view the results using the actions tab on the github site. To show you the results here, I downloaded the logs from the github actions run, here is a subset found toward the bottom of the log:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2022-03-29T19:16:42.4316265Z npm ERR! The `npm ci` command can only install with an existing package-lock.json or</span><br><span class=\"line\">2022-03-29T19:16:42.4318020Z npm ERR! npm-shrinkwrap.json with lockfileVersion &gt;= 1. Run an install with npm@5 or</span><br><span class=\"line\">2022-03-29T19:16:42.4318984Z npm ERR! later to generate a package-lock.json file, then try again.</span><br><span class=\"line\">2022-03-29T19:16:42.4322871Z </span><br><span class=\"line\">2022-03-29T19:16:42.4326362Z npm ERR! A complete log of this run can be found in:</span><br><span class=\"line\">2022-03-29T19:16:42.4327174Z npm ERR!     /home/runner/.npm/_logs/2022-03-29T19_16_39_403Z-debug-0.log</span><br><span class=\"line\">2022-03-29T19:16:42.4388470Z ##[error]Process completed with exit code 1.</span><br><span class=\"line\">2022-03-29T19:16:42.4458441Z Post job cleanup.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Bottom line: the npm ci code was looking for the package-lock file. If you substitute npm install for npm ci, you will not have this problem, but your build will be a little slower. Ok, put the package-lock.json file back by using npm install and check in the new package-lock.json file to gethub.</p>\n<p>This wraps up this article.  What follows is and explaination of the front and back ends. There is 1 more pit fall further down I hit as I was creating the tests.</p>\n<h1 id=\"conculsion\">Conculsion<a title=\"#conculsion\" href=\"#conculsion\"></a></h1>\n<p>Monorepos on github are not difficult to work with. The github actions team provides keywords to watch for changes to specific subdirectories and trigger activity. It is simple enough to write separate configuration yaml files to control for activity in each subdirectory.</p>\n<h1 id=\"appendix\">Appendix<a title=\"#appendix\" href=\"#appendix\"></a></h1>\n<h2 id=\"the-back-end\">The back end<a title=\"#the-back-end\" href=\"#the-back-end\"></a></h2>\n<p>Let’s examine the bend. The main service for the bend is in in the srvr.js file. Nothing magic here as you can see:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// bring in requires library and services. In this case express and CORS</span><br><span class=\"line\">const express = require(&#x27;express&#x27;);</span><br><span class=\"line\">const cors = require(&#x27;cors&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">// establish app as an express server</span><br><span class=\"line\">let app = express();</span><br><span class=\"line\">// suggest a port</span><br><span class=\"line\">let port = 3333;</span><br><span class=\"line\"></span><br><span class=\"line\">// hard code the player information for now.</span><br><span class=\"line\">const players = &#123;</span><br><span class=\"line\">    &quot;graph&quot;: [</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Joan&quot;, &quot;LastName&quot;: &quot;Jet&quot;, &quot;ID&quot;: 1, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;TEE&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Ruth&quot;, &quot;LastName&quot;: &quot;Crist&quot;, &quot;ID&quot;: 2, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;TEE&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Beth&quot;, &quot;LastName&quot;: &quot;Flick&quot;, &quot;ID&quot;: 3, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;TEE&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Julie&quot;, &quot;LastName&quot;: &quot;Ant&quot;, &quot;ID&quot;: 4, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;FWY&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Ginny&quot;, &quot;LastName&quot;: &quot;Grey&quot;, &quot;ID&quot;: 5, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;FWY&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Paula&quot;, &quot;LastName&quot;: &quot;Lamb&quot;, &quot;ID&quot;: 6, &quot;Hole&quot;: 1, &quot;HoleLocation&quot;: &quot;GRN&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Ing&quot;, &quot;LastName&quot;: &quot;Jones&quot;, &quot;ID&quot;: 7, &quot;Hole&quot;: 2, &quot;HoleLocation&quot;: &quot;TEE&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Kelly&quot;, &quot;LastName&quot;: &quot;Smith&quot;, &quot;ID&quot;: 8, &quot;Hole&quot;: 2, &quot;HoleLocation&quot;: &quot;FWY&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Eilean&quot;, &quot;LastName&quot;: &quot;Rams&quot;, &quot;ID&quot;: 9, &quot;Hole&quot;: 2, &quot;HoleLocation&quot;: &quot;GRN&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Barb&quot;, &quot;LastName&quot;: &quot;Sharp&quot;, &quot;ID&quot;: 10, &quot;Hole&quot;: 4, &quot;HoleLocation&quot;: &quot;FWY&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Carol&quot;, &quot;LastName&quot;: &quot;Adams&quot;, &quot;ID&quot;: 11, &quot;Hole&quot;: 4, &quot;HoleLocation&quot;: &quot;FWY&quot; &#125;,</span><br><span class=\"line\">        &#123; &quot;FirstName&quot;: &quot;Faith&quot;, &quot;LastName&quot;: &quot;Hope&quot;, &quot;ID&quot;: 12, &quot;Hole&quot;: 4, &quot;HoleLocation&quot;: &quot;GRN&quot; &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">// get cross-origin resource sharing working so the browaser will not complain</span><br><span class=\"line\">app.use(cors());</span><br><span class=\"line\"></span><br><span class=\"line\">// our 2 API</span><br><span class=\"line\">// /graph returns the array of players and an http status code</span><br><span class=\"line\">app.get(&#x27;/graph&#x27;, (req, resp) =&gt; &#123;</span><br><span class=\"line\">    console.log(&quot;/graph/players...&quot;, players.graph.length);</span><br><span class=\"line\">    resp.setHeader(&#x27;Content-Type&#x27;, &#x27;application/json&#x27;);</span><br><span class=\"line\">    resp.send(JSON.stringify(players.graph));</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">// the top level API </span><br><span class=\"line\">app.get(&#x27;/&#x27;, (request, response) =&gt; &#123;</span><br><span class=\"line\">    console.log(&quot;/...&quot;)</span><br><span class=\"line\">    response.setHeader(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;);</span><br><span class=\"line\">    response.send(&quot;&lt;div&gt;Hello there, welcome&lt;/div&gt;&quot;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">// start the server</span><br><span class=\"line\">app.listen(port, () =&gt; &#123;</span><br><span class=\"line\">    console.log(`app listening on port $&#123;port&#125;`)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">// we need this line to expose the &quot;app&quot; to the testing frame work.</span><br><span class=\"line\">module.exports = app;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"pit-fall-#3---testing-error\">Pit fall #3 - testing error<a title=\"#pit-fall-#3---testing-error\" href=\"#pit-fall-#3---testing-error\"></a></h3>\n<p>This brings us to another pitfall! This is a TESTING pitfall (not a github monorepo pit fall). If you run this code as you see it above and hit “<a href=\"http://localhost:3333/graph\">http://localhost:3333/graph</a>” you will receive the array just as you expect.</p>\n<p>To create a test for this API, we use mocha and chia. The test code looks like this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">import chai from &#x27;chai&#x27;;</span><br><span class=\"line\">import chaiHttp from &#x27;chai-http&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">// import our app so the test code can use it to call the API</span><br><span class=\"line\">//</span><br><span class=\"line\">// Notice that if the srvr.js file does not expose the API calls with </span><br><span class=\"line\">// a module.export command you get an interesting but to help error!!</span><br><span class=\"line\">import app from &#x27;../srvr.js&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">chai.use(chaiHttp);</span><br><span class=\"line\">chai.should();</span><br><span class=\"line\"></span><br><span class=\"line\">describe( &quot;players&quot;, () =&gt; &#123;</span><br><span class=\"line\">    describe(&quot;GET /graph&quot;, () =&gt; &#123;</span><br><span class=\"line\">        it(&quot;Should get all players&quot;, (done) =&gt; &#123;</span><br><span class=\"line\">            chai.request(app)</span><br><span class=\"line\">                .get(&quot;/graph&quot;)</span><br><span class=\"line\">                .end( (err, res) =&gt; &#123;</span><br><span class=\"line\">                    res.should.have.status(200);</span><br><span class=\"line\">                    res.body.should.be.an(&#x27;array&#x27;);</span><br><span class=\"line\">                    done();</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">               </span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Notice line 10!!! The entire srvr.js file is imported and assigned to the variable “app”.  If we comment out line 53 in the srvr.js file we get an error! If you DO NOT use a “modules.export = app” the srvr.js code your test runner can not find the /graph API and you get the following error:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm test</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; bend@1.0.0 test</span><br><span class=\"line\">&gt; mocha --exit</span><br><span class=\"line\"></span><br><span class=\"line\">app listening on port 3333</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  players</span><br><span class=\"line\">    GET /graph</span><br><span class=\"line\">      1) Should get all players</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  0 passing (6ms)</span><br><span class=\"line\">  1 failing</span><br><span class=\"line\"></span><br><span class=\"line\">  1) players</span><br><span class=\"line\">       GET /graph</span><br><span class=\"line\">         Should get all players:</span><br><span class=\"line\">     TypeError: app.address is not a function</span><br><span class=\"line\">      at serverAddress (node_modules/chai-http/lib/request.js:282:18)</span><br><span class=\"line\">      at new Test (node_modules/chai-http/lib/request.js:271:53)</span><br><span class=\"line\">      at Object.obj.&lt;computed&gt; [as get] (node_modules/chai-http/lib/request.js:239:14)</span><br><span class=\"line\">      at Context.&lt;anonymous&gt; (file:///Users/muguira/code/monorepo/bend/test/test.mjs:19:18)</span><br><span class=\"line\">      at processImmediate (node:internal/timers:464:21)</span><br></pre></td></tr></table></figure>\n<p>Your only hint is that the test code fails at line 19? Line 19 is where the test runner is trying to call the “/graph” API. With the modules.export call added, we should see:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm test</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; bend@1.0.0 test</span><br><span class=\"line\">&gt; mocha --exit</span><br><span class=\"line\"></span><br><span class=\"line\">app listening on port 3333</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  players</span><br><span class=\"line\">    GET /graph</span><br><span class=\"line\">/graph/players... 12</span><br><span class=\"line\">      ✔ Should get all players</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  1 passing (17ms)</span><br></pre></td></tr></table></figure>\n<h2 id=\"the-front-end\">The front end<a title=\"#the-front-end\" href=\"#the-front-end\"></a></h2>\n<p>The front end is a simple ReactJS code that uses a react effect hook to call the “/graph” API.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">import React, &#123; useState, useEffect &#125; from &#x27;react&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">// a little styling just to move the displayed array over 20 pixels.</span><br><span class=\"line\">import &#x27;./App.css&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">// getlist contains the fetch call to the API</span><br><span class=\"line\">import &#123; getList &#125; from &#x27;./getList.js&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">function App() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  const [list, setList] = useState([]);</span><br><span class=\"line\"></span><br><span class=\"line\">  useEffect(() =&gt; &#123;</span><br><span class=\"line\">    let mounted = true;</span><br><span class=\"line\">    getList().then(items =&gt; &#123;</span><br><span class=\"line\">      if (mounted) &#123;</span><br><span class=\"line\">        setList(items);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    return () =&gt; mounted = false;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  // console.log(&quot;list==== &quot;, list)</span><br><span class=\"line\">  return (</span><br><span class=\"line\">    &lt;div className=&quot;wrapper&quot;&gt;</span><br><span class=\"line\">      &lt;table&gt;</span><br><span class=\"line\">        &lt;thead&gt;</span><br><span class=\"line\">          &lt;tr&gt;</span><br><span class=\"line\">            &lt;th&gt;Current players&lt;/th&gt;</span><br><span class=\"line\">            &lt;th&gt;Hole&lt;/th&gt;</span><br><span class=\"line\">            &lt;th&gt;Location&lt;/th&gt;</span><br><span class=\"line\">          &lt;/tr&gt;</span><br><span class=\"line\">        &lt;/thead&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;tbody&gt;</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            list.map((el, indx) =&gt; &#123;</span><br><span class=\"line\">              return &lt;tr key=&#123;indx&#125;&gt;</span><br><span class=\"line\">                &lt;td&gt;&#123;el.FirstName&#125; &#123;el.LastName&#125;&lt;/td&gt;</span><br><span class=\"line\">                &lt;td&gt;&#123;el.Hole&#125; &lt;/td&gt;</span><br><span class=\"line\">                &lt;td&gt;&#123;el.HoleLocation&#125;&lt;/td&gt;</span><br><span class=\"line\">              &lt;/tr&gt;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &lt;/tbody&gt;</span><br><span class=\"line\">      &lt;/table&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">  )</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">export default App;</span><br></pre></td></tr></table></figure>\n<p>Nothing magic here.</p>\n<p>The getList.js code is equally simple:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">export function getList() &#123;</span><br><span class=\"line\">    return fetch(&#x27;http://localhost:3333/graph&#x27;)</span><br><span class=\"line\">        .then(data =&gt; &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            return data.json();</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The test code, using Jest is equally easy. I used Jest because the default create-react-app code I started with had everything setup.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &#123; render, screen &#125; from &#x27;@testing-library/react&#x27;;</span><br><span class=\"line\">import App from &#x27;./App&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">test(&#x27;renders Current Players text&#x27;, () =&gt; &#123;</span><br><span class=\"line\">  render(&lt;App /&gt;);</span><br><span class=\"line\">  const linkElement = screen.getByText(/Current players/i);</span><br><span class=\"line\">  expect(linkElement).toBeInTheDocument();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n","next":{"title":"Docker_without_a_base_OS","link":"2022/01/29/Docker-without-a-base-OS"},"plink":"http://muguira-james.github.io/2022/03/29/Using-a-monorepo-with-github/","toc":[{"id":"introduction","title":"Introduction","index":"1"},{"id":"background","title":"Background","index":"2"},{"id":"our-environment","title":"Our environment","index":"3"},{"id":"github-setup","title":"Github setup","index":"4","children":[{"id":"pit-fall-#1---build-and-test-just-the-subsystem-that-changed!","title":"Pit fall #1 - build and test JUST THE SUBSYSTEM that changed!","index":"4.1"},{"id":"pit-fall-#2---why-do-we-have-that-package-lock.json-file?","title":"Pit fall #2 - why do we have that package-lock.json file?","index":"4.2"}]}],"reading_time":"2522 words in 17 min"}