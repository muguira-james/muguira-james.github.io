<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"muguira-james.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="This post is the first in a series describing the creation of a message queue">
<meta property="og:type" content="article">
<meta property="og:title" content="Using Racket to define a message queue - part 1">
<meta property="og:url" content="http://muguira-james.github.io/2021/10/13/A-message-Queue-in-Racket/index.html">
<meta property="og:site_name" content="My musing">
<meta property="og:description" content="This post is the first in a series describing the creation of a message queue">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://muguira-james.github.io/images/MQ-Architecture-1.png">
<meta property="article:published_time" content="2021-10-13T14:26:28.000Z">
<meta property="article:modified_time" content="2022-01-26T02:24:54.563Z">
<meta property="article:author" content="James Muguira">
<meta property="article:tag" content="Racket">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://muguira-james.github.io/images/MQ-Architecture-1.png">


<link rel="canonical" href="http://muguira-james.github.io/2021/10/13/A-message-Queue-in-Racket/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://muguira-james.github.io/2021/10/13/A-message-Queue-in-Racket/","path":"2021/10/13/A-message-Queue-in-Racket/","title":"Using Racket to define a message queue - part 1"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Using Racket to define a message queue - part 1 | My musing</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">My musing</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A place to write and describe</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#A-Message-queue-in-Racket"><span class="nav-number">1.</span> <span class="nav-text">A Message queue in Racket</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Table-contents"><span class="nav-number">1.1.</span> <span class="nav-text">Table contents:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-web-application-shell"><span class="nav-number">1.2.</span> <span class="nav-text">The web application shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Moving-the-code-structure-toward-an-API"><span class="nav-number">1.3.</span> <span class="nav-text">Moving the code structure toward an API</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dispatching"><span class="nav-number">2.</span> <span class="nav-text">Dispatching</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Starting-the-API-code"><span class="nav-number">3.</span> <span class="nav-text">Starting the API code</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">3.1.</span> <span class="nav-text">Conclusion</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">James Muguira</p>
  <div class="site-description" itemprop="description">I write about technology mostly</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://muguira-james.github.io/2021/10/13/A-message-Queue-in-Racket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="James Muguira">
      <meta itemprop="description" content="I write about technology mostly">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My musing">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Using Racket to define a message queue - part 1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-13 10:26:28" itemprop="dateCreated datePublished" datetime="2021-10-13T10:26:28-04:00">2021-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-25 21:24:54" itemprop="dateModified" datetime="2022-01-25T21:24:54-05:00">2022-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/message-queue/" itemprop="url" rel="index"><span itemprop="name">message queue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>This post is the first in a series describing the creation of a message queue </p>
<span id="more"></span>
<h1 id="A-Message-queue-in-Racket"><a href="#A-Message-queue-in-Racket" class="headerlink" title="A Message queue in Racket"></a>A Message queue in Racket</h1><p>This post will explore creating a message queuing application in the Racket programming language.  Racket is a dialect of scheme.  Racket is very well documented on Racket.org. </p>
<p>This is not a tutorial on Racket, the environment, or the language. This post will build up the infrastructure for our message queuing application in several sections. A message queue defines a system that can store messages to specific topics and allow you retrieve these messages in order. The internal data structures used by the messaging system are a hash-table of topics and inside of each hash-table item, a queue to hold the messages for that topic.  The interface to the message queue will provide an API </p>
<ul>
<li>to add / delete messages from a topic</li>
<li>check the number of messages in a topic queue</li>
<li>get a list of the current topics known to the system at that moment</li>
<li>remove topics from the system</li>
<li>remove all the items from a specific topic.</li>
</ul>
<p>The message queue system presents a simple web application interface that utilizes HTTP as an interface and JSON as the low-level data communication language. We will build out the system in sections expanding the capability of our application and demonstrate how to test and verify the code. The final installment will demonstrate how package the system in a container for deployment.</p>
<h2 id="Table-contents"><a href="#Table-contents" class="headerlink" title="Table contents:"></a>Table contents:</h2><ul>
<li>The infrastructure</li>
<li>Dispatching</li>
<li>The start of the API</li>
<li>Conclusion</li>
</ul>
<h2 id="The-web-application-shell"><a href="#The-web-application-shell" class="headerlink" title="The web application shell"></a>The web application shell</h2><p>To start, let’s define a very simple web application using Racket and its supporting HTTP libraries and understand how it works.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#lang racket</span><br><span class="line"></span><br><span class="line">; bring in the required support code to handle socket and HTTP</span><br><span class="line">(require web-server/servlet</span><br><span class="line"></span><br><span class="line">         web-server/servlet-env)</span><br><span class="line"> </span><br><span class="line">; This replies to http get requests with a simple message</span><br><span class="line">(define (my-app req)</span><br><span class="line"></span><br><span class="line">  (response/xexpr</span><br><span class="line"></span><br><span class="line">   `(html (head (title &quot;Hello world!&quot;))</span><br><span class="line">          (body (p &quot;Hey out there!&quot;)))))</span><br><span class="line"> </span><br><span class="line">; start the server and use ‘my-app’ when we get a http  request</span><br><span class="line">(serve/servlet my-app)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The Racket language defines several packages that aid us in creating a web application.  While there are easier ways to start using Racket in a web context, we are going use packages that allows us configuration possibilities later. The sample code just presented loads two packages: the “web-server/servlet” and “web-server/servlet-env” packages.  These packages create an abstraction of a web server.  In this simple case, the server creates something called a servlet, which is a bit of code that replies to a browser request. Our first servlet changes the title of the page to “Hello World”. It also prints the message: “Hey out there”.</p>
<h2 id="Moving-the-code-structure-toward-an-API"><a href="#Moving-the-code-structure-toward-an-API" class="headerlink" title="Moving the code structure toward an API"></a>Moving the code structure toward an API</h2><p>If we run this in the “DrRacket” environment, the default browser opens with the page displayed. </p>
<p>This behavior will not suit us as we create messaging API. Let’s move closer to the infrastructure we need for the API. If you look at the URL in the browser, you will see it says: <a target="_blank" rel="noopener" href="http://localhost:8000/servlets/standalone.rkt">http://localhost:8000/servlets/standalone.rkt</a>.  </p>
<p>Let’s take advantage of Racket’s flexibility. Start by changing the default port the web server is running on. We can change it by adding the scheme symbol: #:port to the last line. This way we have a way to set the port at run-time later when we package the system for deployment. Then, let’s change the URL from: “servlets/standalone.rkt” to “hello”. Last, we don’t want to open a browser each time we start the server. Making all these changes results in the following server start line:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(serve/servlet my-app </span><br><span class="line">      #:port 8000 </span><br><span class="line">      #:servlet-path  “/hello” </span><br><span class="line">      #:launch-browser #f)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>That’s better for the messaging API we’ll develop later in this article.</p>
<h1 id="Dispatching"><a href="#Dispatching" class="headerlink" title="Dispatching"></a>Dispatching</h1><p>In general, a web server is a piece of code that accepts requests and dispatches each request out to handler code for processing.  The handler code might take the incoming payload from the caller and place it in a queue. It might even query a queue and return the queried contents to the caller.  Our message queuing system will allow you to organize messages into different topics. Each topic will have a queue to save the messages. Another example of a handler might to be create a list of topics currently known to the system.</p>
<p>Let’s establish some architecture for our message queue.</p>
<p> <img src="/images/MQ-Architecture-1.png" alt="MQ-ARCH.png"></p>
<p>The system has a front door, which handles processing HTTP requests and returning HTTP responses. There is a middle layer that handles management of the topic hash-table and specific messages under each topic. The message queue is designed to be a component running on a server. We don’t have a graphical front end, but we will need to write a few short programs to drive our API for testing. We’ll get to these later.</p>
<p>For our purpose, let’s define a method that will reply with a simple “hello” string. This string will be used later to determine is the message queue is healthy.  The format of the output string will be “hello <date-time>”.  The date and time can be checked by the caller to determine if there is any lag.  By convention, we’ll assume that we only accept and reply using ASCII characters.  Later, this program will make use of JSON and using ASCII now will simplify our efforts.</p>
<h1 id="Starting-the-API-code"><a href="#Starting-the-API-code" class="headerlink" title="Starting the API code"></a>Starting the API code</h1><p>With our architecture in place, we can start to design our dispatch and API handlers. The front door component of our architecture presents the API to the caller.  The caller is a web app, such as a node JS, python, or Java application. The caller forms a HTTP GET / PUT request and sends it to the front door. It is the front door’s job to validate the request and dispatch it to the correct handler. The handler manipulates the topic hash and hands it results back to the caller.<br>The architecture defines a simple language to interact with the message queue.  As a BNF:</p>
<ul>
<li><p>Message: User_command || Admin_command</p>
</li>
<li><p>User_command: ENQUEUE || DEQUEUE || TOPIC_DATA || QUEUE_DRAIN</p>
</li>
<li><p>ENQUEUE: TOPIC_NAME PAYLOAD, a HTTP POST method call, returns status of “OK” or “Fail”</p>
</li>
<li><p>DEQUEUUE: TOPIC_NAME, a HTTP POST method call, returns the first item on the queue.</p>
</li>
<li><p>QUEUE_DRAIN: TOPIC_NAME, a HTTP POST method call, returns the number of items removed</p>
</li>
<li><p>Admin_command: TOPIC_LIST || TOPIC_COUNT || TOPIC_DRAIN</p>
</li>
<li><p>TOPIC_LIST: TOPIC_NAME, a HTTP POST method call, returns a JSON list of topics currently in the system</p>
</li>
<li><p>TOPIC_COUNT: TOPIC_NAME, a HTTP POST method call, returns integer count of items in the named topic</p>
</li>
<li><p>TOPIC_DRAIN: TOPIC_NAME, a HTTP POST method call, returns the number of removed items in the topic </p>
</li>
<li><p>TOPIC_NAME: ASCII string naming a topic, if the topic is not present it is created</p>
</li>
<li><p>PAYLOAD: ASCII JSON string</p>
</li>
</ul>
<p>The caller forms a message that contains a topic, and a payload which will be placed in the queue on that topic.  For example, we might want to make a to-do topic and place items we want to accomplish today on our to-do topic. The front door would present an “enqueue” API call that accepts a bit of JSON.  In JSON notation, a request to add an item to our to-do list might look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">s''topic: “To-Do”,</span><br><span class="line">s''payload: “study for our CS mid-term”</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The architecture of the front door should be simple. We receive a URL from the lower-level HTTP libraries and use dispatch to select and handle the specifics of the request. Before we create that code let’s attack sending responses back to the caller. We want our response to be in a standard form so a program-based caller can process it. HTTP responses are all formatted in a standard way:</p>
<ul>
<li>A return code, which can be either: 200, 300, 400 or 500,</li>
<li>A return message, such as “OK”,</li>
<li>A time stamp,</li>
<li>The type of the response, for example “TEXT/HTML-MIME_TYPE” or “APPLICATION-JSON”</li>
<li>Additional headers if needed,</li>
<li>The content of the response in 8-bit bytes</li>
</ul>
<p>The Racket code we will use looks like this;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(define (http-response content)  </span><br><span class="line">  (response/full</span><br><span class="line">    200                  		; HTTP response code.</span><br><span class="line">    #&quot;OK&quot;                		; HTTP response message.</span><br><span class="line">    (current-seconds)    		; Timestamp.</span><br><span class="line">    TEXT/HTML-MIME-TYPE  	    ; MIME type for content.</span><br><span class="line">    &#x27;()                     	; Additional HTTP headers.</span><br><span class="line">    (list                		; Content (in bytes) to send to the browser.</span><br><span class="line">      (string-&gt;bytes/utf-8 content))))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The routine takes the content as input and outputs a string as 8-bit ASCII. Later we will extend this to catch and trap errors. That extension will require us changing the response code and response message in case of problems. We will also extend this response code to write a log file.</p>
<p>Now that we have a stand way to form responses let’s address a simple deployment aspect. The first API call we will create will help us monitor the API. It is very simple, for any call to the “monitoring” API, the handler will create a string that consists of the world “hello” and the date and time. It looks like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(define (monitoring request)</span><br><span class="line">  ; just say something useful</span><br><span class="line">  (http-response &quot;Hello: (today/utc))&quot;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The date and time are supplied by the (require gregor) package reference.  To use this in the DrRacket editor you need to use the package manager and load in gregor-lib. With the library loaded, the monitoring API will utilize the http-response method we just wrote to create a simple message for output.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have started on our journey to use Racket to create a message queue component.  The article has created a simple web application and an architecture for the message queue.  The application presents a simple monitoring API endpoint that responses with a “Hello” message when called. We’ve also created a standard way to format responses to the caller that we can use from each API endpoint we define.</p>
<p>The next article will define an enqueue and a dequeue API call and redefine the architecture to handling testing of our end-points.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Racket/" rel="tag"># Racket</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/20/2021-09-20-Docker-with-racket/" rel="prev" title="Using Racket in Docker containers">
                  <i class="fa fa-chevron-left"></i> Using Racket in Docker containers
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/10/22/A-message-queue-racket-part-2/" rel="next" title="A Message queue in Racket - part 2">
                  A Message queue in Racket - part 2 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">James Muguira</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
